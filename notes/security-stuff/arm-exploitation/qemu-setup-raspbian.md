---
layout: default
title: Emulate Rasbpian with QEMU
parent: ARM exploitation
grand_parent: security stuff
nav_order: 2
---

1. TOC
{:toc}


- Download raspbian image from the official repository <https://www.raspberrypi.org/downloads/raspbian/>
- Download qemu-rpi-kernel AND .dtb file <https://github.com/dhruvvyas90/qemu-rpi-kernel>

## How to emulate Rasbpian Buster with qemu
- mount the image temporarily
```
sudo mount -v -o offset=276824064 -t ext4 2019-07-10-raspbian-buster-lite.img /mnt/tmp
```
- edit etc/ld.so.preload and comment out the first and only line
- change the following lines in /etc/fstab
```
### change these lines
PARTUUID=17869b7d-01  /boot           vfat    defaults          0       2      
PARTUUID=17869b7d-02  /               ext4    defaults,noatime  0       1

### to this

/dev/sda1  /boot           vfat    defaults          0       2      
/dev/sda2  /               ext4    defaults,noatime  0       1

### save and exit
```

- Now start QEMU:  
<small>Note: the following will spawn a new QEMU window , but will fail to initialize the GUI display. I have not found a workaround at this time. Instead, it should boot directly into a shell in the same window the command is executed from.<small>
```
  qemu-system-arm \
    -kernel kernel-qemu-4.19.50-buster \
    -dtb ../versatile-pb.dtb \
    -hda 2019-07-10-raspbian-buster-lite.img \
    -cpu arm1176 \
    -m 256 \
    -M versatilepb \
    -serial stdio \
    -net nic \
    -net user,hostfwd=tcp::5022-:22 \
    -append "root=/dev/sda2 rootfstype=ext4 rw" \
    -no-reboot
```

  - `-serial stdio` : redirects the boot output messages and the console to your terminal.
  - `-kernel kernel-qemu-4.19.50-buster` : relative path to kernel file
  - `-dtb ../versatile-pb.dtb` : relative path to dtb file
  - `-hda 2019-07-10-raspbian-buster-lite.img` : relative path to raspbian image file
  - `--cpu arm1176` : select CPU model
  - `-m 256` : guest RAM size in megabytes
  - `M versatilepb` : general-purpose Linux target in the past; disadvantage is that it has a very old CPU and only 256MB of RAM
  - `append "root=/dev/sda2 rootfstype=ext4 rw"` : contains all options to be passed to the kernel at boot time
  - `-net nic -net user,hostfwd=tcp::5022-:22` : forwards the guest port 22 to local port 5022, for ssh'ing to the machine

---
# How to emulate Raspbian Jessie with qemu
<small>Note: the following will spawn a new QEMU window with the expected Rasbpian GUI<small>
```
qemu-system-arm \
  -kernel kernel-qemu-4.4.34-jessie \
  -cpu arm1176 \
  -m 256 \
  -M versatilepb \
  -serial stdio \
  -append "root=/dev/sda2 rootfstype=ext4 rw" \
  -hda 2017-04-10-raspbian-jessie.img \
  -net nic -net user,hostfwd=tcp::5022-:22 \
  -no-reboot
```

---

## Resources and More
{: .no_toc }
- <https://wiki.qemu.org/Documentation/Platforms/ARM>
- <https://wiki.debian.org/QEMU#Networking>
- <https://github.com/dhruvvyas90/qemu-rpi-kernel/wiki>
- <https://github.com/dhruvvyas90/qemu-rpi-kernel>
- <https://azeria-labs.com/emulate-raspberry-pi-with-qemu/>
